# Barqly Vault Storage Design

## Overview

Barqly Vault implements a clean, organized storage architecture with two distinct storage contexts: **non-syncable private data** (keys, logs) and **syncable public data** (vaults, recovery files). This separation ensures security while enabling cloud synchronization where appropriate.

## Cross-Platform Compatibility

**Important**: Barqly Vault is designed for **macOS, Linux, and Windows**. While this document uses macOS paths as examples, the implementation uses platform-appropriate directories:

| Platform | Private Storage | Public Storage |
|----------|----------------|----------------|
| **macOS** | `~/Library/Application Support/com.Barqly.Vault/` | `~/Documents/` |
| **Linux** | `~/.config/barqly-vault/` or `$XDG_CONFIG_HOME/barqly-vault/` | `~/Documents/` |
| **Windows** | `%APPDATA%\Barqly Vault\` | `%USERPROFILE%\Documents\` |

**Implementation Note**: The codebase uses Tauri's platform-specific directory APIs to ensure correct paths on each operating system. All examples in this document show macOS paths for consistency, but the actual implementation handles platform differences automatically.

## Storage Architecture

### Two Storage Contexts

#### 1. Non-Syncable Private Storage
**Location**: Platform-specific app data directory (see Cross-Platform table above)
**Purpose**: Sensitive data that should never be synchronized or shared
**Contents**:
- **Key Registry**: `keys/barqly-vault-key-registry.json` - Central registry of all encryption keys
- **Encrypted Key Files**: `keys/*.agekey.enc` - Individual passphrase key files
- **Application Logs**: `logs/` - Runtime logs and debugging information

#### 2. Syncable Public Storage
**Location**: Platform-specific Documents directory (see Cross-Platform table above)
**Purpose**: Data designed for cloud sync, backup, and sharing
**Contents**:
- **Barqly-Vaults**: Future vault storage location (not yet implemented)
- **Barqly-Recovery**: Decrypted files with per-operation manifests

## Design Principles

1. **Security Separation**: Private keys never in syncable locations
2. **Single Registry**: One global key registry for all vault operations
3. **Per-Operation Manifests**: Each recovery operation gets its own manifest
4. **Future Signing**: Manifests structured for digital signature verification
5. **Cloud-Ready**: Public folders designed for synchronization services

## Current Storage Implementation

### 1. Key Registry (`~/Library/Application Support/com.Barqly.Vault/keys/barqly-vault-key-registry.json`)

**Purpose**: Central registry tracking all encryption keys across vault-independent operations
**Scope**: Global - vault independent
**Structure**:

```json
{
  "version": "2.0",
  "keys": 
  {
    "keyref_PgkexL1UcCM": {
      "type": "passphrase",
      "label": "Kello-key",
      "created_at": "2025-09-24T04:06:28.948793Z",
      "last_used": null,
      "public_key": "age1grsgnuuz2hyp6k7suvk800wguwfkfk70ec3akedfe3k67g97hp5qpdrtnc",
      "key_filename": "Kello-key"
    },
    "keyref_ZS5ZBHdwU2v": 
    {
      "type": "yubikey",
      "label": "YubiKey-3131",
      "created_at": "2025-09-24T04:06:39.940729Z",
      "last_used": null,
      "serial": "31310420",
      "slot": 1,
      "piv_slot": 82,
      "recipient": "age1yubikey1qt2fxtd4l2cdfyxd5dn9mq7h57d8lhn6zurqwnrvcuwwpgh38dsuumlzqnu",
      "identity_tag": "AGE-PLUGIN-YUBIKEY-12NPD6QVZ4TKWT3QAQ9MVU",
      "firmware_version": null,
      "recovery_code_hash": "673d08901f2fbccbbe27620c2acf16e30d7aa9dbd3211222f71c36697975dc46"
    }
  }
}
```

### 2. Per-Operation Recovery Manifest (`~/Documents/Barqly-Recovery/{timestamp}/{filename}.manifest`)

**Purpose**: Documents specific decryption operation with file metadata
**Scope**: Per-operation - included alongside decrypted files
**Structure**:

```json
{
  "manifest_version": "0.1.0",
  "app_version": "0.1.0",
  "id": "JR6zd8BqPgbYeeMpiqne7v",
  "name": "Hello World 2",
  "description": null,
  "created_at": "2025-09-24T04:06:05.601943Z",
  "updated_at": "2025-09-24T04:06:47.350393Z",
  "keys": [
    "keyref_PgkexL1UcCM",
    "keyref_ZS5ZBHdwU2v"
  ],
  "encrypted_archives": [
    {
      "filename": "Hello World 2.age",
      "encrypted_at": "2025-09-24T04:06:47.350392Z",
      "total_files": 1,
      "total_size": "50.1 KB",
      "contents": [
        {
          "file": "PEO GRADE 8 STUDENT HOURS.pdf",
          "size": "50.1 KB",
          "hash": "51584bf57302516cb7f0d24196fdec162f4d3df8bf463be07215e6576a1ccca9"
        }
      ]
    }
  ]
}
```

## Detailed Storage Locations

### Private Storage (Platform-Specific App Data Directory)

**macOS Example** (`~/Library/Application Support/com.Barqly.Vault/`):
```
~/Library/Application Support/com.Barqly.Vault/
├── keys/
│   ├── barqly-vault-key-registry.json    # Central key registry
│   ├── mbp2030-nauman.agekey.enc         # Encrypted passphrase key
│   └── yubikey-5c-nano.agekey.enc        # YubiKey backup (future)
└── logs/
    ├── app-2025-09-24.log                # Daily application logs
    └── debug-2025-09-24.log              # Debug logs
```

**Linux Example** (`~/.config/barqly-vault/`):
```
~/.config/barqly-vault/
├── keys/
│   ├── barqly-vault-key-registry.json
│   └── *.agekey.enc
└── logs/
    └── *.log
```

**Windows Example** (`%APPDATA%\Barqly Vault\`):
```
%APPDATA%\Barqly Vault\
├── keys\
│   ├── barqly-vault-key-registry.json
│   └── *.agekey.enc
└── logs\
    └── *.log
```

**Characteristics**:
- ⛔ **Never sync**: Contains private keys and sensitive logs
- 🔒 **Security critical**: Key compromise = vault compromise
- 📱 **Platform-standard**: Uses OS-appropriate app data directory
- 🗂️ **Centralized**: Single registry for all operations

### Public Storage (Platform-Specific Documents Directory)

**Cross-Platform Example** (Documents folder on each OS):
```
Documents/
├── Barqly-Vaults/                        # Future: Vault storage
│   └── (not yet implemented)
└── Barqly-Recovery/                      # Decryption outputs
    └── 2025-09-24_210733/                # Timestamped operation
        ├── Hello World 2.txt             # Recovered file
        └── Hello World 2.manifest        # Operation manifest
```

**Characteristics**:
- ☁️ **Cloud-syncable**: Safe for backup and sync services
- 👥 **Shareable**: Recovery folders can be shared
- 📁 **User-accessible**: In familiar Documents location across all platforms
- 🗓️ **Timestamped**: Each operation gets unique folder

## Key Registry Evolution

### Stage 1: Initial Registry
```json
{
  "version": "1.0.0",
  "entries": []
}
```

### Stage 2: Passphrase Key Added
```json
{
  "version": "1.0.0",
  "entries": [
    {
      "id": "keyref_XREr5Z45gSF",
      "entry_type": "Passphrase",
      "label": "mbp2030-nauman",
      "created_at": "2025-09-24T02:17:57.405281Z",
      "last_used": null,
      "public_key": "age1abc123...",
      "key_filename": "mbp2030-nauman"
    }
  ]
}
```

### Stage 3: YubiKey Added
```json
{
  "version": "1.0.0",
  "entries": [
    {
      "id": "keyref_XREr5Z45gSF",
      "entry_type": "Passphrase",
      "label": "mbp2030-nauman",
      "created_at": "2025-09-24T02:17:57.405281Z",
      "last_used": "2025-09-24T03:41:42.007144Z",
      "public_key": "age1abc123...",
      "key_filename": "mbp2030-nauman"
    },
    {
      "id": "keyref_YBK9Z67hgTR",
      "entry_type": "Yubikey",
      "label": "yubikey-5c-nano",
      "created_at": "2025-09-24T02:18:45.123456Z",
      "last_used": null,
      "serial": "31310420",
      "slot": 1,
      "piv_slot": 82,
      "recipient": "age1yubikey1qt2fxtd4l2cdfyxd5dn9mq7h57d8lhn6zurqwnrvcuwwpgh38dsuumlzqnu",
      "identity_tag": "AGE-PLUGIN-YUBIKEY-1QT2FXTD4L2",
      "key_filename": "yubikey-5c-nano"
    }
  ]
}
```

## Security Model

### Private Storage Security
- **Key Registry**: Contains all key references but not actual private keys
- **Encrypted Key Files**: Passphrase keys encrypted with user passphrase
- **YubiKey Protection**: Hardware-backed keys never leave the device
- **Logs**: May contain sensitive debugging info, kept private

### Public Storage Security
- **Recovery Manifests**: Safe to sync - no private key material
- **Decrypted Files**: User-controlled location with clear intent
- **Future Signing**: Manifests designed for digital signature verification

## Current Implementation Benefits

### Simplified Architecture
- **Two Manifest System**: Avoids complexity of vault-based storage
- **Global Key Registry**: Vault-independent key management
- **Per-Operation Recovery**: Clear audit trail for each decryption
- **Separation of Concerns**: Keys vs operations cleanly separated

### Cloud Sync Friendly
- **Private/Public Separation**: Clear boundaries for what can be synced
- **Timestamped Recovery**: Each operation gets unique folder
- **No Key Leakage**: Private keys never in syncable locations
- **User Control**: Recovery location is user-visible and accessible

## Future Considerations

### Potential Enhancements
1. **Vault-Based Storage**: Move to `~/Documents/Barqly-Vaults/` for organized vault management
2. **Digital Signatures**: Sign manifests for integrity verification
3. **Key Rotation**: Track key lifecycle and rotation events
4. **Audit Logging**: Enhanced operation history and security events
5. **Backup Automation**: Automated backup of key registry

### Migration Strategy
If vault-based storage is implemented:
1. **Preserve Key Registry**: Maintain global key registry for backward compatibility
2. **Gradual Migration**: Support both models during transition
3. **Import/Export**: Tools to move between storage models
4. **Version Management**: Clear versioning for storage format evolution

## Implementation Notes

### Current Workflow
1. **Key Registration**: Add to global registry in private storage
2. **Encryption**: Use keys from registry, output to user-specified location
3. **Decryption**: Load keys from registry, output to timestamped recovery folder
4. **Recovery Manifest**: Document operation alongside recovered files

### Key Benefits of Current Design
- ✅ **Security**: Private keys never leave secure storage
- ✅ **Simplicity**: Two manifest types serve clear purposes
- ✅ **Flexibility**: Vault-independent key management
- ✅ **Auditability**: Clear operation history in recovery folders
- ✅ **Sync-Safe**: Public folders designed for cloud sync

---

*This storage design balances security, usability, and future extensibility while maintaining clear separation between private key material and syncable operation data.*