â†’ RUST_LOG=info cargo run
warning: fields `timestamp`, `bytes_read`, and `error` are never read
   --> src/main.rs:791:5
    |
790 | struct ReadEvent {
    |        --------- fields in this struct
791 |     timestamp: Duration,
    |     ^^^^^^^^^
792 |     event_type: ReadEventType,
793 |     bytes_read: usize,
    |     ^^^^^^^^^^
794 |     error: Option<String>,
    |     ^^^^^
    |
    = note: `ReadEvent` has a derived impl for the trait `Debug`, but this is intentionally ignored during dead code analysis
    = note: `#[warn(dead_code)]` on by default

warning: `pty-yubikey-test` (bin "pty-yubikey-test") generated 1 warning
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.04s
     Running `target/debug/pty-yubikey-test`
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Starting PTY YubiKey Test POC - Phase 1: Complete YubiKey Workflow with PIN Automation
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] === PHASE 1 OBJECTIVES ===
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] 1. Initialize YubiKey with proper security settings (3 critical steps)
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] 2. Demonstrate programmatic PIN input via PTY stdin
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] 3. Complete age-plugin-yubikey workflow without hanging
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] 4. Prove TouchPolicy::Never + automated PIN = success
[2025-09-13T22:15:27Z INFO  pty_yubikey_test]
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] === CONFIGURATION ===
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Touch Policy: Never
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Target PIN: 212121
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Target PUK: 212121
[2025-09-13T22:15:27Z INFO  pty_yubikey_test]
    === STEP 1: YubiKey Initialization ===
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] === YubiKey Initialization Phase ===
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Implementing 3 critical security initialization steps:
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] 1. Change PIN from 123456 to 212121
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] 2. Change PUK from 12345678 to 212121 (same as PIN)
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] 3. Change management key to random TDES with PIN protection
[2025-09-13T22:15:27Z INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] YubiKey detected, serial: Serial(31310420)
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Checking YubiKey state...
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] YubiKey is using default PIN - needs initialization
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Step 1: Changing PIN from 123456 to 212121...
[2025-09-13T22:15:27Z INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] âœ… PIN SUCCESSFULLY CHANGED: 123456 â†’ 212121
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Step 2: Changing PUK from 12345678 to 212121 (same as PIN)...
[2025-09-13T22:15:27Z INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] âœ… PUK SUCCESSFULLY CHANGED: 12345678 â†’ 212121 (same as PIN)
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Step 3: Changing management key to TDES with PIN protection...
[2025-09-13T22:15:27Z INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Cannot authenticate with default management key - it may already be changed
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Management key changed successfully to TDES with PIN protection
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] YubiKey initialization complete
[2025-09-13T22:15:27Z INFO  pty_yubikey_test]
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] ðŸ“‹ ========================================
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] ðŸ“‹ INITIALIZATION SUMMARY:
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] ðŸ“‹ PIN Status: âœ… Changed to 212121
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] ðŸ“‹ PUK Status: âœ… Changed to 212121 (same as PIN)
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] ðŸ“‹ Management Key: Attempted TDES change with PIN protection
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] ðŸ“‹ Current PIN to use: 212121
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] ðŸ“‹ ========================================
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] YubiKey initialization phase completed
[2025-09-13T22:15:27Z INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Using target PIN: 212121
[2025-09-13T22:15:27Z INFO  pty_yubikey_test]
    === STEP 2: PTY + PIN Automation Tests ===
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Using PIN: 212121 for tests
[2025-09-13T22:15:27Z INFO  pty_yubikey_test]
    --- Running Test 1/4: Simple echo command - should complete quickly ---
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] === Starting PTY Test ===
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Description: Simple echo command - should complete quickly
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Command: ["echo", "hello world"]
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Timeout: 5s
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Expects PIN Input: false
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] PIN to provide: None
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Created PTY pair with size: PtySize { rows: 24, cols: 80, pixel_width: 0, pixel_height: 0 }
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] === COMMAND DETAILS ===
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Executable: echo
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Arguments: ["hello world"]
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Full command: ["echo", "hello world"]
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Spawned process with PID: Some(32150)
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Cloned PTY master reader and writer for PIN automation
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Read 13 bytes: "hello world\r\n"
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Process completed with exit status: ExitStatus { code: 0, signal: None }
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Final read returned 0 bytes (clean EOF after process exit)
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] === FULL COMMAND OUTPUT ===
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Output: hello world

[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Output length: 13 bytes
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] === Test Completed ===
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Success: true
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Duration: 17.582417ms
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Total bytes read: 13
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Completion reason: ProcessExit
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Exit code: Some(0)
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Read events: 2
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Test 1 completed successfully
[2025-09-13T22:15:27Z INFO  pty_yubikey_test] Waiting 3 seconds before next test...
[2025-09-13T22:15:30Z INFO  pty_yubikey_test]
    --- Running Test 2/4: age-plugin-yubikey help - no YubiKey interaction ---
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] === Starting PTY Test ===
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Description: age-plugin-yubikey help - no YubiKey interaction
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Command: ["age-plugin-yubikey", "--help"]
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Timeout: 10s
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Expects PIN Input: false
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] PIN to provide: None
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Created PTY pair with size: PtySize { rows: 24, cols: 80, pixel_width: 0, pixel_height: 0 }
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] === COMMAND DETAILS ===
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Executable: age-plugin-yubikey
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Arguments: ["--help"]
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Full command: ["age-plugin-yubikey", "--help"]
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] AGE-PLUGIN-YUBIKEY OPERATION:
[2025-09-13T22:15:30Z INFO  pty_yubikey_test]   Arg[0]: age-plugin-yubikey
[2025-09-13T22:15:30Z INFO  pty_yubikey_test]   Arg[1]: --help
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Spawned process with PID: Some(32160)
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Cloned PTY master reader and writer for PIN automation
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Read 208 bytes: "\u{1b}[0m\u{1b}[38;5;8m[\u{1b}[0m\u{1b}[0m\u{1b}[32mINFO \u{1b}[0m i18n_embed::requester\u{1b}[0m\u{1b}[38;5;8m]\u{1b}[0m Current Locale: [LanguageIdentifier { language: Language(Some(\"en\")), script: None, region: Some(Region(\"US\")), variants: None }]\r\n"
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] YubiKey Operation Output: [INFO  i18n_embed::requester] Current Locale: [LanguageIdentifier { language: Language(Some("en")), script: None, region: Some(Region("US")), variants: None }]

[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Read 1024 bytes: "Usage: age-plugin-yubikey [OPTIONS]\r\n\r\nOptional arguments:\r\n  -h, --help                  Print this help message and exit.\r\n  -V, --version               Print version info and exit.\r\n  --age-plugin STATE-MACHINE  Run the given age plugin state machine. Internal use only.\r\n  -f, --force                 Force --generate to overwrite a filled slot.\r\n  -g, --generate              Generate a new YubiKey identity.\r\n  -i, --identity              Print identities stored in connected YubiKeys.\r\n  -l, --list                  List recipients for age identities in connected YubiKeys.\r\n  --list-all                  List recipients for all YubiKey keys that are compatible with age.\r\n  --name NAME                 Name for the generated identity. Defaults to 'age identity HEX_TAG'.\r\n  --pin-policy PIN-POLICY     One of [always, once, never]. Defaults to 'once'.\r\n  --serial SERIAL             Specify which YubiKey to use, if more than one is plugged in.\r\n  --slot SLOT                 Specify which slot to use. Defaults to f"
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] YubiKey Operation Output: Usage: age-plugin-yubikey [OPTIONS]

    Optional arguments:
      -h, --help                  Print this help message and exit.
      -V, --version               Print version info and exit.
      --age-plugin STATE-MACHINE  Run the given age plugin state machine. Internal use only.
      -f, --force                 Force --generate to overwrite a filled slot.
      -g, --generate              Generate a new YubiKey identity.
      -i, --identity              Print identities stored in connected YubiKeys.
      -l, --list                  List recipients for age identities in connected YubiKeys.
      --list-all                  List recipients for all YubiKey keys that are compatible with age.
      --name NAME                 Name for the generated identity. Defaults to 'age identity HEX_TAG'.
      --pin-policy PIN-POLICY     One of [always, once, never]. Defaults to 'once'.
      --serial SERIAL             Specify which YubiKey to use, if more than one is plugged in.
      --slot SLOT                 Specify which slot to use. Defaults to f
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Command success indicator: Usage: age-plugin-yubikey [OPTIONS]

    Optional arguments:
      -h, --help                  Print this help message and exit.
      -V, --version               Print version info and exit.
      --age-plugin STATE-MACHINE  Run the given age plugin state machine. Internal use only.
      -f, --force                 Force --generate to overwrite a filled slot.
      -g, --generate              Generate a new YubiKey identity.
      -i, --identity              Print identities stored in connected YubiKeys.
      -l, --list                  List recipients for age identities in connected YubiKeys.
      --list-all                  List recipients for all YubiKey keys that are compatible with age.
      --name NAME                 Name for the generated identity. Defaults to 'age identity HEX_TAG'.
      --pin-policy PIN-POLICY     One of [always, once, never]. Defaults to 'once'.
      --serial SERIAL             Specify which YubiKey to use, if more than one is plugged in.
      --slot SLOT                 Specify which slot to use. Defaults to f
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Read 104 bytes: "irst usable slot.\r\n  --touch-policy TOUCH-POLICY One of [always, cached, never]. Defaults to 'always'.\r\n"
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] YubiKey Operation Output: irst usable slot.
      --touch-policy TOUCH-POLICY One of [always, cached, never]. Defaults to 'always'.

[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Process completed with exit status: ExitStatus { code: 0, signal: None }
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Final read returned 0 bytes (clean EOF after process exit)
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] === FULL COMMAND OUTPUT ===
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Output: [INFO  i18n_embed::requester] Current Locale: [LanguageIdentifier { language: Language(Some("en")), script: None, region: Some(Region("US")), variants: None }]
    Usage: age-plugin-yubikey [OPTIONS]

    Optional arguments:
      -h, --help                  Print this help message and exit.
      -V, --version               Print version info and exit.
      --age-plugin STATE-MACHINE  Run the given age plugin state machine. Internal use only.
      -f, --force                 Force --generate to overwrite a filled slot.
      -g, --generate              Generate a new YubiKey identity.
      -i, --identity              Print identities stored in connected YubiKeys.
      -l, --list                  List recipients for age identities in connected YubiKeys.
      --list-all                  List recipients for all YubiKey keys that are compatible with age.
      --name NAME                 Name for the generated identity. Defaults to 'age identity HEX_TAG'.
      --pin-policy PIN-POLICY     One of [always, once, never]. Defaults to 'once'.
      --serial SERIAL             Specify which YubiKey to use, if more than one is plugged in.
      --slot SLOT                 Specify which slot to use. Defaults to first usable slot.
      --touch-policy TOUCH-POLICY One of [always, cached, never]. Defaults to 'always'.

[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Output length: 1336 bytes
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] === YUBIKEY OPERATION ANALYSIS ===
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] YubiKey detected in output
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Touch policy help text displayed (not an actual touch requirement)
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] === Test Completed ===
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Success: true
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Duration: 51.533709ms
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Total bytes read: 1336
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Completion reason: ProcessExit
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Exit code: Some(0)
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Read events: 4
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Test 2 completed successfully
[2025-09-13T22:15:30Z INFO  pty_yubikey_test] Waiting 3 seconds before next test...
[2025-09-13T22:15:33Z INFO  pty_yubikey_test]
    --- Running Test 3/4: Generate age key with TouchPolicy::Never + automated PIN input ---
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] This test will automatically provide PIN: Some("212121")
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] === Starting PTY Test ===
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Description: Generate age key with TouchPolicy::Never + automated PIN input
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Command: ["age-plugin-yubikey", "--generate", "--touch-policy", "never", "--name", "test-key-automated"]
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Timeout: 120s
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Expects PIN Input: true
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] PIN to provide: Some("212121")
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Created PTY pair with size: PtySize { rows: 24, cols: 80, pixel_width: 0, pixel_height: 0 }
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] === COMMAND DETAILS ===
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Executable: age-plugin-yubikey
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Arguments: ["--generate", "--touch-policy", "never", "--name", "test-key-automated"]
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Full command: ["age-plugin-yubikey", "--generate", "--touch-policy", "never", "--name", "test-key-automated"]
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] AGE-PLUGIN-YUBIKEY OPERATION:
[2025-09-13T22:15:33Z INFO  pty_yubikey_test]   Arg[0]: age-plugin-yubikey
[2025-09-13T22:15:33Z INFO  pty_yubikey_test]   Arg[1]: --generate
[2025-09-13T22:15:33Z INFO  pty_yubikey_test]   Arg[2]: --touch-policy
[2025-09-13T22:15:33Z INFO  pty_yubikey_test]   Arg[3]: never
[2025-09-13T22:15:33Z INFO  pty_yubikey_test]   Arg[4]: --name
[2025-09-13T22:15:33Z INFO  pty_yubikey_test]   Arg[5]: test-key-automated
[2025-09-13T22:15:33Z INFO  pty_yubikey_test]   TOUCH POLICY: never (critical for hanging behavior)
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Spawned process with PID: Some(32161)
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Cloned PTY master reader and writer for PIN automation
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Read 208 bytes: "\u{1b}[0m\u{1b}[38;5;8m[\u{1b}[0m\u{1b}[0m\u{1b}[32mINFO \u{1b}[0m i18n_embed::requester\u{1b}[0m\u{1b}[38;5;8m]\u{1b}[0m Current Locale: [LanguageIdentifier { language: Language(Some(\"en\")), script: None, region: Some(Region(\"US\")), variants: None }]\r\n"
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] YubiKey Operation Output: [INFO  i18n_embed::requester] Current Locale: [LanguageIdentifier { language: Language(Some("en")), script: None, region: Some(Region("US")), variants: None }]

[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Read 119 bytes: "\u{1b}[0m\u{1b}[38;5;8m[\u{1b}[0m\u{1b}[0m\u{1b}[32mINFO \u{1b}[0m yubikey::yubikey\u{1b}[0m\u{1b}[38;5;8m]\u{1b}[0m connected to reader: Yubico YubiKey FIDO+CCID\r\n"
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] YubiKey Operation Output: [INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID

[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Read 357 bytes: "\u{1b}[0m\u{1b}[38;5;8m[\u{1b}[0m\u{1b}[0m\u{1b}[32mINFO \u{1b}[0m yubikey::yubikey\u{1b}[0m\u{1b}[38;5;8m]\u{1b}[0m connected to reader: Yubico YubiKey FIDO+CCID\r\n\u{1b}[0m\u{1b}[38;5;8m[\u{1b}[0m\u{1b}[0m\u{1b}[32mINFO \u{1b}[0m yubikey::yubikey\u{1b}[0m\u{1b}[38;5;8m]\u{1b}[0m connected to reader: Yubico YubiKey FIDO+CCID\r\n\u{1b}[0m\u{1b}[38;5;8m[\u{1b}[0m\u{1b}[0m\u{1b}[32mINFO \u{1b}[0m yubikey::yubikey\u{1b}[0m\u{1b}[38;5;8m]\u{1b}[0m connected to reader: Yubico YubiKey FIDO+CCID\r\n"
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] YubiKey Operation Output: [INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID
    [INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID
    [INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID

[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Read 26 bytes: "ðŸŽ² Generating key...\r\n\r\n"
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] YubiKey Operation Output: ðŸŽ² Generating key...


[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Read 65 bytes: "\rEnter PIN for YubiKey with serial 31310420 (default is 123456): "
Enter PIN for YubiKey with serial 31310420 (default is 123456): Output:
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] PIN prompt detected! Automatically providing PIN: 212121
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Successfully wrote PIN to PTY stdin
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] PTY stdin flushed successfully
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Read 212 bytes: "\r\n\u{1b}[1A\r\u{1b}[2K\u{1b}[1B\u{1b}[1AEnter PIN for YubiKey with serial 31310420 (default is 123456): [hidden]\r\n\u{1b}[0m\u{1b}[38;5;8m[\u{1b}[0m\u{1b}[0m\u{1b}[1m\u{1b}[31mERROR\u{1b}[0m yubikey::mgm\u{1b}[0m\u{1b}[38;5;8m]\u{1b}[0m could not read protected data (err: NotFound)\r\n"
Enter PIN for YubiKey with serial 31310420 (default is 123456): [hidden]
    [ERROR yubikey::mgm] could not read protected data (err: NotFound)

[2025-09-13T22:15:33Z INFO  pty_yubikey_test] PIN prompt detected! Automatically providing PIN: 212121
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Successfully wrote PIN to PTY stdin
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] PTY stdin flushed successfully
Enter PIN for YubiKey with serial 31310420 (default is 123456): [hidden]
    [ERROR yubikey::mgm] could not read protected data (err: NotFound)

[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Read 467 bytes: "212121\r\nError: Custom unprotected non-TDES management keys are not supported.\r\nYou can use the YubiKey Manager CLI to change to a protected management key:\r\n  ykman piv access change-management-key -a TDES --protect\r\n\r\nSee here for more information about YubiKey Manager:\r\n  https://developers.yubico.com/yubikey-manager/\r\n\r\n[ Did this not do what you expected? Could an error be more useful? ]\r\n[ Tell us: https://str4d.xyz/age-plugin-yubikey/report              ]\r\n"
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] YubiKey Operation Output: 212121
    Error: Custom unprotected non-TDES management keys are not supported.
    You can use the YubiKey Manager CLI to change to a protected management key:
      ykman piv access change-management-key -a TDES --protect

    See here for more information about YubiKey Manager:
      https://developers.yubico.com/yubikey-manager/

    [ Did this not do what you expected? Could an error be more useful? ]
    [ Tell us: https://str4d.xyz/age-plugin-yubikey/report              ]

[2025-09-13T22:15:33Z WARN  pty_yubikey_test] Command error detected: 212121
    Error: Custom unprotected non-TDES management keys are not supported.
    You can use the YubiKey Manager CLI to change to a protected management key:
      ykman piv access change-management-key -a TDES --protect

    See here for more information about YubiKey Manager:
      https://developers.yubico.com/yubikey-manager/

    [ Did this not do what you expected? Could an error be more useful? ]
    [ Tell us: https://str4d.xyz/age-plugin-yubikey/report              ]

[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Process completed with exit status: ExitStatus { code: 1, signal: None }
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Final read returned 0 bytes (clean EOF after process exit)
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] === FULL COMMAND OUTPUT ===
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Output: [INFO  i18n_embed::requester] Current Locale: [LanguageIdentifier { language: Language(Some("en")), script: None, region: Some(Region("US")), variants: None }]
    [INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID
    [INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID
    [INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID
    [INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID
    ðŸŽ² Generating key...

Enter PIN for YubiKey with serial 31310420 (default is 123456): [hidden]
    [ERROR yubikey::mgm] could not read protected data (err: NotFound)
    212121
    Error: Custom unprotected non-TDES management keys are not supported.
    You can use the YubiKey Manager CLI to change to a protected management key:
      ykman piv access change-management-key -a TDES --protect

    See here for more information about YubiKey Manager:
      https://developers.yubico.com/yubikey-manager/

    [ Did this not do what you expected? Could an error be more useful? ]
    [ Tell us: https://str4d.xyz/age-plugin-yubikey/report              ]

[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Output length: 1454 bytes
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] === YUBIKEY OPERATION ANALYSIS ===
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] YubiKey detected in output
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] PIN prompt was handled automatically
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] === Test Completed ===
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Success: true
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Duration: 130.722458ms
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Total bytes read: 1454
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Completion reason: ProcessExit
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Exit code: Some(1)
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Read events: 8
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Test 3 completed successfully
[2025-09-13T22:15:33Z INFO  pty_yubikey_test] Waiting 3 seconds before next test...
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]
    --- Running Test 4/4: List age identities with automated PIN input ---
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] This test will automatically provide PIN: Some("212121")
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] === Starting PTY Test ===
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Description: List age identities with automated PIN input
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Command: ["age-plugin-yubikey", "--identity"]
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Timeout: 60s
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Expects PIN Input: true
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] PIN to provide: Some("212121")
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Created PTY pair with size: PtySize { rows: 24, cols: 80, pixel_width: 0, pixel_height: 0 }
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] === COMMAND DETAILS ===
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Executable: age-plugin-yubikey
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Arguments: ["--identity"]
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Full command: ["age-plugin-yubikey", "--identity"]
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] AGE-PLUGIN-YUBIKEY OPERATION:
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Arg[0]: age-plugin-yubikey
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Arg[1]: --identity
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Spawned process with PID: Some(32163)
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Cloned PTY master reader and writer for PIN automation
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Read 208 bytes: "\u{1b}[0m\u{1b}[38;5;8m[\u{1b}[0m\u{1b}[0m\u{1b}[32mINFO \u{1b}[0m i18n_embed::requester\u{1b}[0m\u{1b}[38;5;8m]\u{1b}[0m Current Locale: [LanguageIdentifier { language: Language(Some(\"en\")), script: None, region: Some(Region(\"US\")), variants: None }]\r\n"
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] YubiKey Operation Output: [INFO  i18n_embed::requester] Current Locale: [LanguageIdentifier { language: Language(Some("en")), script: None, region: Some(Region("US")), variants: None }]

[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Read 119 bytes: "\u{1b}[0m\u{1b}[38;5;8m[\u{1b}[0m\u{1b}[0m\u{1b}[32mINFO \u{1b}[0m yubikey::yubikey\u{1b}[0m\u{1b}[38;5;8m]\u{1b}[0m connected to reader: Yubico YubiKey FIDO+CCID\r\n"
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] YubiKey Operation Output: [INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID

[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Read 119 bytes: "\u{1b}[0m\u{1b}[38;5;8m[\u{1b}[0m\u{1b}[0m\u{1b}[32mINFO \u{1b}[0m yubikey::yubikey\u{1b}[0m\u{1b}[38;5;8m]\u{1b}[0m connected to reader: Yubico YubiKey FIDO+CCID\r\n"
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] YubiKey Operation Output: [INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID

[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Read 2 bytes: "\r\n"
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] YubiKey Operation Output:

[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Process completed with exit status: ExitStatus { code: 0, signal: None }
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Final read returned 0 bytes (clean EOF after process exit)
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] === FULL COMMAND OUTPUT ===
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Output: [INFO  i18n_embed::requester] Current Locale: [LanguageIdentifier { language: Language(Some("en")), script: None, region: Some(Region("US")), variants: None }]
    [INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID
    [INFO  yubikey::yubikey] connected to reader: Yubico YubiKey FIDO+CCID


[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Output length: 448 bytes
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] === YUBIKEY OPERATION ANALYSIS ===
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] YubiKey detected in output
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] === Test Completed ===
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Success: true
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Duration: 83.467625ms
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Total bytes read: 448
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Completion reason: ProcessExit
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Exit code: Some(0)
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Read events: 5
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Test 4 completed successfully
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]
    === STEP 3: PHASE 1 RESULTS ANALYSIS ===
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Completed 4 tests
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] Overall successful tests: 4/4
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] age-plugin-yubikey successful tests: 3/3
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]
    Test 1: ["echo", "hello world"]
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Success: true
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Duration: 17.582417ms
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Bytes read: 13
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Completion: ProcessExit
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Exit code: Some(0)
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Read events: 2
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]     EOF events: 0, Data events: 1, Error events: 0
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]
    Test 2: ["age-plugin-yubikey", "--help"]
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Success: true
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Duration: 51.533709ms
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Bytes read: 1336
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Completion: ProcessExit
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Exit code: Some(0)
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Read events: 4
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]     EOF events: 0, Data events: 3, Error events: 0
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]
    Test 3: ["age-plugin-yubikey", "--generate", "--touch-policy", "never", "--name", "test-key-automated"]
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Success: true
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Duration: 130.722458ms
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Bytes read: 1454
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Completion: ProcessExit
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Exit code: Some(1)
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Read events: 8
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]     EOF events: 0, Data events: 7, Error events: 0
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]
    Test 4: ["age-plugin-yubikey", "--identity"]
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Success: true
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Duration: 83.467625ms
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Bytes read: 448
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Completion: ProcessExit
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Exit code: Some(0)
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]   Read events: 5
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]     EOF events: 0, Data events: 4, Error events: 0
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]
    === PHASE 1 CONCLUSION ===
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] âœ“ PHASE 1 SUCCESS: All age-plugin-yubikey tests completed without hanging!
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] âœ“ YubiKey properly initialized with 3 critical security steps
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] âœ“ PIN automation via PTY stdin works correctly
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] âœ“ TouchPolicy::Never + automated PIN = complete workflow
[2025-09-13T22:15:36Z INFO  pty_yubikey_test] âœ“ No false touch warnings from help text
[2025-09-13T22:15:36Z INFO  pty_yubikey_test]
    Phase 1 implementation complete with proper YubiKey initialization.
