#!/bin/bash

# Barqly Vault Pre-commit Hook
# This hook validates code quality before commits

set -e

echo "ğŸ” Barqly Vault Pre-commit Validation"
echo "======================================"

# Check if we're in the src-tauri directory or if it exists
if [ -d "src-tauri" ]; then
    echo "ğŸ“¦ Rust project detected. Running validation..."
    cd src-tauri
    
    # Run cargo fmt
    echo "ğŸ¨ Running cargo fmt..."
    if ! cargo fmt --check; then
        echo "âŒ Code formatting issues found!"
        echo "ğŸ’¡ Run 'cargo fmt' to fix formatting"
        exit 1
    fi
    echo "âœ… Formatting check passed"
    
    # Run cargo clippy with strict settings (same as CI)
    echo "ğŸ” Running cargo clippy..."
    if ! cargo clippy --all-targets --all-features -- -D warnings; then
        echo "âŒ Clippy linting issues found!"
        echo "ğŸ’¡ Fix the issues above and try again"
        exit 1
    fi
    echo "âœ… Clippy check passed"
    
    # Run tests
    echo "ğŸ§ª Running tests..."
    if ! cargo test; then
        echo "âŒ Tests failed!"
        echo "ğŸ’¡ Fix the failing tests and try again"
        exit 1
    fi
    echo "âœ… All tests passed"
    
    cd ..
    echo ""
    echo "ğŸ‰ All validation checks passed!"
    echo "ğŸ“ Proceeding with commit..."
    echo ""
else
    echo "â„¹ï¸  No Rust project found, skipping Rust validation"
fi

# Check for any staged files that might need validation
echo "ğŸ“‹ Checking staged files..."

# Check for frontend files and run validation
if git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx|json|css|html)$' > /dev/null; then
    echo "ğŸŒ Frontend files detected. Running validation..."
    
    if [ -d "src-ui" ]; then
        cd src-ui
        
        # Check if node_modules exists, if not install dependencies
        if [ ! -d "node_modules" ]; then
            echo "ğŸ“¦ Installing frontend dependencies..."
            npm install
        fi
        
        # Run Prettier formatting check
        echo "ğŸ¨ Running Prettier formatting check..."
        if ! npx prettier --check .; then
            echo "âŒ Code formatting issues found!"
            echo "ğŸ’¡ Run 'npx prettier --write .' in src-ui/ to fix formatting"
            exit 1
        fi
        echo "âœ… Formatting check passed"
        
        # Run ESLint
        echo "ğŸ” Running ESLint..."
        if ! npm run lint; then
            echo "âŒ ESLint issues found!"
            echo "ğŸ’¡ Fix the linting issues above and try again"
            exit 1
        fi
        echo "âœ… ESLint check passed"
        
        # Run TypeScript type checking
        echo "ğŸ”§ Running TypeScript type check..."
        if ! npx tsc --noEmit; then
            echo "âŒ TypeScript type errors found!"
            echo "ğŸ’¡ Fix the type errors above and try again"
            exit 1
        fi
        echo "âœ… TypeScript check passed"
        
        # Run tests (if they exist)
        if npm run test --if-present; then
            echo "âœ… Tests passed"
        else
            echo "âš ï¸  No tests configured or tests failed"
        fi
        
        cd ..
        echo ""
        echo "ğŸ‰ All frontend validation checks passed!"
        echo ""
    else
        echo "âš ï¸  Frontend files detected but src-ui/ directory not found"
    fi
fi

# Smart Demo Mode Pipeline
echo "ğŸ¤– Smart Demo Mode Pipeline"
echo "=========================="

# Detect if we're in a development context
IS_DEV_CONTEXT=false
if [[ "$OSTYPE" == "darwin"* ]] || [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Check if we're on a development machine (not CI)
    if [ -n "$USER" ] && [ "$USER" != "runner" ] && [ "$USER" != "ubuntu" ] && [ "$USER" != "circleci" ]; then
        IS_DEV_CONTEXT=true
    fi
fi

# Check if demo mode is enabled
DEMO_ENABLED=false
if [ -f "src-ui/src/App.production.tsx" ]; then
    DEMO_ENABLED=true
fi

echo "ğŸ” Context Analysis:"
echo "   Development Environment: $IS_DEV_CONTEXT"
echo "   Demo Mode Enabled: $DEMO_ENABLED"

# Smart decision making
if [ "$IS_DEV_CONTEXT" = true ] && [ "$DEMO_ENABLED" = true ]; then
    echo "âœ… Development + Demo Mode: Perfect for development workflow"
    echo "ğŸ’¡ Keeping demo mode enabled for continued development"
elif [ "$IS_DEV_CONTEXT" = true ] && [ "$DEMO_ENABLED" = false ]; then
    echo "âš ï¸  Development + Production Mode: Switching to demo mode for development"
    echo "ğŸ”„ Enabling demo mode for better development experience..."
    node scripts/switch-to-demo.js demo
    echo "âœ… Demo mode enabled for development"
elif [ "$IS_DEV_CONTEXT" = false ] && [ "$DEMO_ENABLED" = true ]; then
    echo "ğŸš¨ CI/Production + Demo Mode: CRITICAL - Switching to production mode"
    echo "ğŸ”„ Automatically switching to production mode for safety..."
    node scripts/switch-to-demo.js production
    echo "âœ… Production mode enforced for CI/Production environment"
else
    echo "âœ… CI/Production + Production Mode: Perfect for deployment"
fi

echo "ğŸ‰ All validation checks passed!"
echo "ğŸ“ Proceeding with commit..."
echo ""

exit 0 