#!/bin/bash

# Barqly Vault Pre-commit Hook
# This hook validates code quality before commits

set -e

echo "ğŸ” Barqly Vault Pre-commit Validation"
echo "======================================"

# Check if we're in the src-tauri directory or if it exists
if [ -d "src-tauri" ]; then
    echo "ğŸ“¦ Rust project detected. Running validation..."
    cd src-tauri
    
    # Run cargo fmt
    echo "ğŸ¨ Running cargo fmt..."
    if ! cargo fmt --check; then
        echo "âŒ Code formatting issues found!"
        echo "ğŸ’¡ Run 'cargo fmt' to fix formatting"
        exit 1
    fi
    echo "âœ… Formatting check passed"
    
    # Run cargo clippy with strict settings (same as CI)
    echo "ğŸ” Running cargo clippy..."
    if ! cargo clippy --all-targets --all-features -- -D warnings; then
        echo "âŒ Clippy linting issues found!"
        echo "ğŸ’¡ Fix the issues above and try again"
        exit 1
    fi
    echo "âœ… Clippy check passed"
    
    # Run tests
    echo "ğŸ§ª Running tests..."
    if ! cargo test; then
        echo "âŒ Tests failed!"
        echo "ğŸ’¡ Fix the failing tests and try again"
        exit 1
    fi
    echo "âœ… All tests passed"
    
    cd ..
    echo ""
    echo "ğŸ‰ All validation checks passed!"
    echo "ğŸ“ Proceeding with commit..."
    echo ""
else
    echo "â„¹ï¸  No Rust project found, skipping Rust validation"
fi

# Check for any staged files that might need validation
echo "ğŸ“‹ Checking staged files..."

# Check for any .ts/.tsx files (frontend validation)
if git diff --cached --name-only | grep -E '\.(ts|tsx)$' > /dev/null; then
    echo "ğŸŒ TypeScript files detected"
    if [ -d "src-ui" ]; then
        echo "ğŸ’¡ Consider running 'npm run lint' and 'npm run test' in src-ui/"
    fi
fi

exit 0 