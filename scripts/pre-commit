#!/bin/bash

# Barqly Vault Pre-commit Hook
# This hook validates code quality before commits
# Implements shift-left: automated validation at the earliest possible stage

set -e

echo "ğŸ” Barqly Vault Pre-commit Validation"
echo "======================================"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_status() {
    local status=$1
    local message=$2
    case $status in
        "success")
            echo -e "${GREEN}âœ… $message${NC}"
            ;;
        "error")
            echo -e "${RED}âŒ $message${NC}"
            ;;
        "warning")
            echo -e "${YELLOW}âš ï¸  $message${NC}"
            ;;
        "info")
            echo -e "â„¹ï¸  $message"
            ;;
    esac
}

# ============================================================================
# SHIFT-LEFT: COMPREHENSIVE VALIDATION (Mirrors CI exactly)
# ============================================================================
print_status "info" "ğŸš€ Shift-Left: Running comprehensive validation..."

# Check if we're in the right directory
if [ ! -d "src-tauri" ] || [ ! -d "src-ui" ]; then
    print_status "error" "Must be run from the project root directory"
    exit 1
fi

# ============================================================================
# RUST VALIDATION (Mirrors CI exactly)
# ============================================================================
print_status "info" "ğŸ“¦ Rust project validation..."

cd src-tauri

# Cargo fetch (same as CI)
print_status "info" "ğŸ“¦ Running cargo fetch..."
cargo fetch

# Cargo fmt check (EXACTLY like CI)
print_status "info" "ğŸ¨ Running cargo fmt..."
if ! cargo fmt --all -- --check; then
    print_status "error" "Code formatting issues found!"
    print_status "info" "ğŸ’¡ Run 'cargo fmt --all' to fix formatting"
    exit 1
fi
print_status "success" "Formatting check passed"

# Cargo clippy (same as CI)
print_status "info" "ğŸ” Running cargo clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    print_status "error" "Clippy linting issues found!"
    print_status "info" "ğŸ’¡ Fix the issues above and try again"
    exit 1
fi
print_status "success" "Clippy check passed"

# Cargo build (EXACTLY like CI)
print_status "info" "ğŸ—ï¸  Running cargo build..."
if ! cargo build --release; then
    print_status "error" "Build failed!"
    print_status "info" "ğŸ’¡ Fix the build errors above and try again"
    exit 1
fi
print_status "success" "Build passed"

# Cargo test (EXACTLY like CI)
print_status "info" "ğŸ§ª Running tests..."
if ! cargo test --all; then
    print_status "error" "Tests failed!"
    print_status "info" "ğŸ’¡ Fix the failing tests and try again"
    exit 1
fi
print_status "success" "All tests passed"

cd ..

# ============================================================================
# FRONTEND VALIDATION (Mirrors CI exactly)
# ============================================================================
print_status "info" "ğŸŒ Frontend project validation..."

cd src-ui

# Check dependencies (use same method as CI)
if [ ! -d "node_modules" ]; then
    print_status "info" "ğŸ“¦ Installing dependencies (matching CI)..."
    npm ci --prefer-offline --no-audit
fi

# Prettier formatting check (same as CI)
print_status "info" "ğŸ¨ Running Prettier formatting check..."
if ! npx prettier --check .; then
    print_status "error" "Code formatting issues found!"
    print_status "info" "ğŸ’¡ Run 'npx prettier --write .' in src-ui/ to fix formatting"
    exit 1
fi
print_status "success" "Formatting check passed"

# ESLint (EXACTLY like CI)
print_status "info" "ğŸ” Running ESLint..."
if ! npx eslint . --max-warnings=0; then
    print_status "error" "ESLint issues found!"
    print_status "info" "ğŸ’¡ Fix the linting issues above and try again"
    exit 1
fi
print_status "success" "ESLint check passed"

# TypeScript type checking (EXACTLY like CI)
print_status "info" "ğŸ”§ Running TypeScript type check..."
if ! npx tsc --noEmit; then
    print_status "error" "TypeScript type errors found!"
    print_status "info" "ğŸ’¡ Fix the type errors above and try again"
    exit 1
fi
print_status "success" "TypeScript check passed"

# Production build (EXACTLY like CI)
print_status "info" "ğŸ—ï¸  Running production build..."
if ! npm run build; then
    print_status "error" "Production build failed!"
    print_status "info" "ğŸ’¡ Fix the build errors above and try again"
    exit 1
fi
print_status "success" "Production build passed"

# Tests (EXACTLY like CI)
print_status "info" "ğŸ§ª Running frontend tests..."
if ! npm test -- --run --coverage; then
    print_status "error" "Frontend tests failed!"
    print_status "info" "ğŸ’¡ Fix the failing tests and try again"
    exit 1
fi
print_status "success" "All frontend tests passed"

cd ..

# ============================================================================
# SHIFT-LEFT: HOLISTIC VALIDATION
# ============================================================================
print_status "info" "ğŸ¯ Holistic validation: Ensuring everything is in sync..."

# Check for any uncommitted changes
if [ -n "$(git status --porcelain)" ]; then
    print_status "warning" "Uncommitted changes detected"
    print_status "info" "ğŸ’¡ Consider committing your changes before proceeding"
else
    print_status "success" "Working directory is clean"
fi

# Check if pre-commit hook is installed
if [ -f ".git/hooks/pre-commit" ]; then
    print_status "success" "Pre-commit hook is installed"
else
    print_status "warning" "Pre-commit hook is not installed"
    print_status "info" "ğŸ’¡ Run 'npm run setup-hooks' to install hooks"
fi

# ============================================================================
# SMART DEMO MODE PIPELINE (Existing functionality)
# ============================================================================
echo ""
echo "ğŸ¤– Smart Demo Mode Pipeline"
echo "=========================="

# Detect if we're in a development context
IS_DEV_CONTEXT=false
if [[ "$OSTYPE" == "darwin"* ]] || [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Check if we're on a development machine (not CI)
    if [ -n "$USER" ] && [ "$USER" != "runner" ] && [ "$USER" != "ubuntu" ] && [ "$USER" != "circleci" ]; then
        IS_DEV_CONTEXT=true
    fi
fi

# Check if demo mode is enabled
DEMO_ENABLED=false
if [ -f "src-ui/src/App.production.tsx" ]; then
    DEMO_ENABLED=true
fi

echo "ğŸ” Context Analysis:"
echo "   Development Environment: $IS_DEV_CONTEXT"
echo "   Demo Mode Enabled: $DEMO_ENABLED"

# Smart decision making
if [ "$IS_DEV_CONTEXT" = true ] && [ "$DEMO_ENABLED" = true ]; then
    echo "âœ… Development + Demo Mode: Perfect for development workflow"
    echo "ğŸ’¡ Keeping demo mode enabled for continued development"
elif [ "$IS_DEV_CONTEXT" = true ] && [ "$DEMO_ENABLED" = false ]; then
    echo "âš ï¸  Development + Production Mode: Switching to demo mode for development"
    echo "ğŸ”„ Enabling demo mode for better development experience..."
    node scripts/switch-to-demo.js demo
    echo "âœ… Demo mode enabled for development"
elif [ "$IS_DEV_CONTEXT" = false ] && [ "$DEMO_ENABLED" = true ]; then
    echo "ğŸš¨ CI/Production + Demo Mode: CRITICAL - Switching to production mode"
    echo "ğŸ”„ Automatically switching to production mode for safety..."
    node scripts/switch-to-demo.js production
    echo "âœ… Production mode enforced for CI/Production environment"
else
    echo "âœ… CI/Production + Production Mode: Perfect for deployment"
fi

print_status "success" "ğŸ‰ All validation checks passed!"
print_status "info" "ğŸš€ Shift-Left: Your code is ready for commit and CI will pass!"

echo ""
echo "ğŸ“‹ Shift-Left Validation Summary:"
echo "   âœ… Rust: fmt, clippy, tests"
echo "   âœ… Frontend: prettier, eslint, typescript, build, tests"
echo "   âœ… Environment: clean working directory"
echo "   âœ… Holistic: everything in sync"
echo ""
echo "ğŸ’¡ Shift-Left Benefits:"
echo "   â€¢ Automated validation at earliest stage"
echo "   â€¢ No manual steps required"
echo "   â€¢ Immediate feedback loops"
echo "   â€¢ CI will pass because local mirrors CI exactly"
echo ""

exit 0 